# Code Review Report: SC-3 Black Screen Issue

**Date:** 2025-07-28 23:07:49
**File Reviewed:** `src/pei_docker/gui/screens/simple/project_info.py`
**Issue:** The SC-3 (Project Information) screen appears as a "black screen" upon startup.

## 1. Summary of Findings

The root cause of the "black screen" issue lies within the `ProjectInfoWidget` class, which is the component used by the main wizard controller. The class contains several critical `AttributeError` bugs that prevent it from rendering correctly. These errors stem from an incomplete refactoring, where logic from the unused `ProjectInfoScreen` class was not correctly adapted for the `ProjectInfoWidget`.

## 2. Key Issues Identified

### Issue 1: Fatal `AttributeError` in `is_valid()` method (High Severity)

- **Location:** `ProjectInfoWidget.is_valid`
- **Problem:** The method attempts to access `self.config.validate()`. However, the `config` attribute (an instance of `ProjectInfoConfig`) is never initialized on `ProjectInfoWidget`. This causes an `AttributeError`, likely crashing the rendering process when the wizard controller validates the step.
- **Evidence:**
  ```python
  # In ProjectInfoWidget
  def is_valid(self) -> bool:
      """Check if all inputs are valid for navigation control."""
      validation_result = self.config.validate() # CRASH: self.config does not exist
      return validation_result.is_valid
  ```

### Issue 2: Fatal `AttributeError` in `on_project_name_changed` handler (High Severity)

- **Location:** `ProjectInfoWidget.on_project_name_changed`
- **Problem:** This event handler, triggered when the user types a project name, calls `self._update_image_preview()`. This method is not defined anywhere within the `ProjectInfoWidget` class.
- **Evidence:**
  ```python
  # In ProjectInfoWidget
  @on(Input.Changed, "#project_name")
  def on_project_name_changed(self, event: Input.Changed) -> None:
      """Handle project name input changes with real-time validation."""
      # ...
      self._update_image_preview() # CRASH: method does not exist
  ```

### Issue 3: `NoMatches` Error due to Conditional Widget Creation (Medium Severity)

- **Location:** `ProjectInfoWidget.compose`
- **Problem:** The `Static` widget used to preview the Docker image names (`id="image_preview"`) is only mounted if `self.project_config.project_name` is set during initialization. If the widget starts with no project name, this preview widget is never created. The (missing) `_update_image_preview` method would then fail to find it with `self.query_one("#image_preview", Static)`, raising a `NoMatches` error.
- **Evidence:**
  ```python
  # In ProjectInfoWidget.compose
  # Image Preview
  if self.project_config.project_name: # Problematic condition
      stage1_image = f"{self.project_config.project_name}:stage-1"
      stage2_image = f"{self.project_config.project_name}:stage-2"
      yield Static(
          f"Docker images: {stage1_image}, {stage2_image}",
          classes="preview-text",
          id="image_preview" # This widget only exists if the condition is met
      )
  ```

## 3. Verification with Documentation

The identified issues directly correlate with the documented behavior of the Textual framework.

-   **Lifecycle Exceptions:** The Textual application operates on an event loop and a component lifecycle (including the `compose` method and `on_*` event handlers). As is standard in event-driven GUI frameworks, an unhandled Python exception (like `AttributeError` or `NoMatches`) during these critical lifecycle methods will interrupt the rendering and event-processing loop. This breakage prevents the UI from being drawn or updated, resulting in the observed "black screen."

-   **Widget Querying:** The documentation for Textual's query methods (like `query_one`) implies that they are used to retrieve widgets that are already part of the DOM. The method `query_one` is designed to raise a `NoMatches` error if the specified widget does not exist. The conditional creation of the `#image_preview` widget in `compose` violates the expectation that the widget will always be available for querying, leading directly to this exception.

-   **Event Handling:** The `@on` decorator is used to link user actions (like `Input.Changed`) to handler methods. The documentation shows these handlers are where application logic resides. If this logic is faulty and raises an exception, the application's ability to respond to user input will break.

These points confirm that the bugs identified are not just simple coding errors, but violations of Textual's fundamental operational principles, leading to the reported failure.

## 4. Recommended Solutions

To resolve these issues, the `ProjectInfoWidget` class must be corrected to be self-contained and free of these errors.

### Solution for Issue 1: Fix `is_valid()`

The `is_valid` method should create a temporary `ProjectInfoConfig` object using the current state from `self.project_config` to perform validation.

**Suggested Code:**
```python
# In ProjectInfoWidget
from .project_info import ProjectInfoConfig # Ensure this is imported if not already

def is_valid(self) -> bool:
    """Check if all inputs are valid for navigation control."""
    # Create a temporary config object from the live project_config for validation
    temp_config = ProjectInfoConfig(
        project_name=self.project_config.project_name,
        base_image=self.project_config.stage_1.base_image,
    )
    validation_result = temp_config.validate()
    return validation_result.is_valid
```

### Solution for Issues 2 & 3: Implement `_update_image_preview()` and fix `compose()`

First, add the missing `_update_image_preview` method. Second, modify the `compose` method to *always* create the `#image_preview` widget, and simply update its content and visibility.

**Suggested Code:**

```python
# In ProjectInfoWidget class

def _update_image_preview(self) -> None:
    """Update the image preview display."""
    try:
        preview_label = self.query_one("#image_preview", Static)
        if self.project_config.project_name:
            stage1_image = f"{self.project_config.project_name}:stage-1"
            stage2_image = f"{self.project_config.project_name}:stage-2"
            preview_label.update(f"Docker images: {stage1_image}, {stage2_image}")
            preview_label.display = True
        else:
            # Hide the label or show placeholder text when there is no project name
            preview_label.update("")
            preview_label.display = False
    except NoMatches:
        # This should no longer happen with the corrected compose method
        pass

def compose(self) -> ComposeResult:
    """Compose the project information widget."""
    with Container(classes="project-info-container"):
        yield Label("Basic project settings:", classes="section-header")
        yield Static()  # Spacer

        # Project Name Field
        yield Horizontal(
            Label("Project Name: *", classes="field-label"),
            classes="field-row"
        )
        yield Input(
            value=self.project_config.project_name,
            placeholder="Enter project name...",
            id="project_name",
            classes="project-input"
        )

        # Image Preview - ALWAYS create it
        yield Static(
            "", # Start with empty content
            classes="preview-text",
            id="image_preview"
        )
        # Call the update method to set initial state
        self.call_after_refresh(self._update_image_preview)

        yield Static()  # Spacer

        # Base Image Field
        yield Horizontal(
            Label("Base Docker Image: *", classes="field-label"),
            classes="field-row"
        )
        yield Input(
            value=self.project_config.stage_1.base_image,
            placeholder="ubuntu:24.04",
            id="base_image",
            classes="base-image-input"
        )

        yield Static()  # Spacer
        yield Static("* Required field", classes="required-note")

# Add the new method to the class
ProjectInfoWidget._update_image_preview = _update_image_preview
```
*Note: The final line is for conceptual clarity; the method should be defined directly within the class body.*

## 5. References

- **Textual Documentation (ID: `/textualize/textual`)**:
  - **`textual.widget.Widget.compose`**: This method is fundamental for building the static UI of a widget. An exception here will prevent the widget and its children from being rendered.
  - **`@on` decorator and Event Handling**: Used to define application logic in response to events. An exception in an `on_` handler will break the application's response to that event.
  - **`textual.widget.Widget.query_one`**: The API is designed to retrieve a *single* widget. If the widget is not found (due to not being mounted), a `textual.css.query.NoMatches` exception is raised, which must be handled.
  - The documentation confirms that the "black screen" issue is a classic symptom of an unhandled exception during the `compose`, `on_mount`, or other lifecycle methods, which fully aligns with the findings of this review.

By implementing these changes, the `AttributeError` and `NoMatches` exceptions will be resolved, allowing the `ProjectInfoWidget` to render correctly and function as intended within the wizard.
