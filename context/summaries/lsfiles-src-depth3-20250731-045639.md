# File Structure Documentation: src/ Directory (Depth 3)

Generated on: 2025-07-31 04:56:39  
Scope: 3 levels deep from src/ directory

## Directory Tree (Depth 3)

```
src/
└── pei_docker/                    # Main PeiDocker package
    ├── __init__.py               # Package initialization
    ├── _version.py               # Version information
    ├── config_processor.py       # Configuration processing engine
    ├── pei.py                    # Main CLI entry point
    ├── pei_utils.py              # Utility functions
    ├── user_config.py            # Configuration data structures
    ├── examples/                 # YAML configuration examples (17 files)
    ├── gui/                      # Textual-based GUI application
    │   ├── README.md
    │   ├── __init__.py
    │   ├── app.py                # Main GUI application class
    │   ├── models/               # Data models for GUI
    │   ├── screens/              # GUI screen implementations
    │   ├── utils/                # GUI utility functions
    │   └── widgets/              # Custom GUI widgets
    ├── project_files/            # Template files for Docker projects
    │   ├── installation/         # Installation scripts and templates
    │   ├── stage-1.Dockerfile    # First stage Docker template
    │   └── stage-2.Dockerfile    # Second stage Docker template
    ├── templates/                # Configuration templates
    │   ├── base-image-gen.yml    # Base image generation template
    │   └── config-template-full.yml # Complete configuration reference
    └── webgui/                   # Web-based GUI (placeholder)
```

## Core Module Files

### Main Entry Points

#### `pei.py` - CLI Entry Point
**Primary Functions:**
- `create_command()` - Creates new project directory with templates
- `configure_command()` - Processes configuration and generates docker-compose.yml
- `remove_command()` - Safely removes Docker images and containers
- `main()` - CLI argument parsing and command dispatch

**Key Features:**
- Environment variable substitution (${VAR:-default} syntax)
- Safety confirmations for destructive operations
- Docker resource dependency checking

#### `__init__.py` - Package Initialization
**Purpose:** Package imports and version exposure
**Content:** Defines public API and imports core components

#### `_version.py` - Version Management
**Purpose:** Centralized version string definition
**Content:** Package version constant for CLI and GUI

### Core Processing Engine

#### `config_processor.py` - Configuration Engine
**Main Class:** `PeiConfigProcessor`
**Key Methods:**
- `process_config()` - Main configuration processing pipeline
- `apply_apt_settings()` - APT repository configuration
- `apply_proxy_settings()` - HTTP proxy setup
- `apply_ssh_settings()` - SSH server and user configuration
- `apply_storage_settings()` - Volume and mount processing
- `apply_custom_scripts()` - Custom script lifecycle management

**Configuration Classes:**
- `StorageTypes` - Enum for storage type validation
- `StoragePrefixes` - Path prefix constants
- `StoragePaths` - Container path mappings
- `Defaults` - Default configuration values

#### `user_config.py` - Data Structures
**Main Class:** `UserConfig` - Root configuration container
**Stage Configuration:** `StageConfig` - Per-stage settings

**Configuration Components:**
- `ImageConfig` - Base and output image specifications
- `SSHConfig` - SSH server setup and user management
- `ProxyConfig` - HTTP proxy settings for build and runtime
- `AptConfig` - APT repository mirror configuration
- `DeviceConfig` - CPU/GPU hardware specification
- `CustomScriptConfig` - Lifecycle hook script management
- `StorageOption` - Volume mounting configuration

**Key Features:**
- Type-safe validation with attrs decorators
- Automatic format conversion (list ↔ dict)
- Two-stage architecture support (Stage-1 → Stage-2)

#### `pei_utils.py` - Utility Functions
**Purpose:** Common helper functions
**Typical Functions:** File operations, path handling, system utilities

## Directory Contents (Depth 3)

### `examples/` - Configuration Examples (17 files)
**Purpose:** Demonstration YAML configurations for various use cases

**Categories:**
- **Basic Setup:** `minimal-ubuntu-ssh.yml`
- **GPU/Graphics:** `gpu-with-host-mount.yml`, `gpu-with-opengl-win32.yml`, `python-with-opengl.yml`
- **Development:** `pixi-basic-cpu.yml`, `pixi-ml-gpu.yml`, `pixi-with-volumes.yml`
- **Storage:** `mount-arbitrary-vol.yml`, `mount-external-docker-vol.yml`
- **Proxy:** `with-proxy-across-stages.yml`, `with-proxy-in-build.yml`, `with-proxy-in-run.yml`, `with-proxy-manually.yml`
- **AI/ML:** `invoke-ai-by-pip.yml`
- **Security:** `ssh-keys-inline.yml`
- **Environment:** `environment-variables.yml`
- **Comprehensive:** `with-everything.yml`

### `gui/` - Textual GUI Application
**Main Application:** `app.py`
**Primary Class:** `PeiDockerApp` (Textual App)
**Key Methods:**
- `on_mount()` - Application initialization
- `on_screen_switch()` - Navigation management
- `compose()` - UI composition and screen routing

**Subdirectories:**
- `models/` - Pydantic data models for form validation
- `screens/` - Screen implementations (startup, project setup, wizard steps)
- `utils/` - Docker integration and file system utilities
- `widgets/` - Custom input components and dialogs

**GUI Architecture:**
- Screen-based navigation (SC-0 to SC-13)
- Wizard-style configuration flow
- Docker availability checking
- Cross-platform file path handling

### `project_files/` - Docker Project Templates
**Purpose:** Template files copied to new projects

**Structure:**
- `installation/` - Script templates and Docker build context
  - Contains stage-1 and stage-2 directory structures
  - Custom script examples and system setup scripts
- `stage-1.Dockerfile` - First build stage template
- `stage-2.Dockerfile` - Second build stage template (with dynamic storage)

**Key Features:**
- Two-stage Docker build system
- Script lifecycle management (build, first-run, every-run, user-login)
- Extensive system setup scripts (APT, proxy, SSH, GPU, development tools)

### `templates/` - Configuration Templates
#### `config-template-full.yml` - Complete Configuration Reference
**Purpose:** Comprehensive example showing all available configuration parameters
**Content:** 
- Complete stage_1 and stage_2 configuration examples
- All configuration options with documentation
- Used as reference for GUI form generation

#### `base-image-gen.yml` - Base Image Template
**Purpose:** Template for base image generation workflow
**Content:** Base image build configuration parameters

### `webgui/` - Web GUI Placeholder
**Status:** Empty directory reserved for future NiceGUI-based web interface
**Purpose:** Planned web-based alternative to the Textual GUI

## Key Architectural Patterns

### Two-Stage Build System
1. **Stage-1:** Foundation image with system-level setup
   - Base OS configuration, APT packages, SSH, proxy
   - System-wide settings and utilities
2. **Stage-2:** Application image with enhanced features
   - Built on top of Stage-1 image
   - Dynamic storage system (`/soft/` → `/hard/volume/` or `/hard/image/`)
   - Application-specific configurations

### Configuration Processing Pipeline
1. **Parse:** YAML configuration to typed data structures
2. **Validate:** Type checking and constraint validation
3. **Transform:** Apply configurations to Docker templates
4. **Generate:** Output docker-compose.yml with all settings

### Script Lifecycle Management
- **Build-time:** `on_build` scripts during image creation
- **Runtime:** `on_first_run` (once) and `on_every_run` (always)
- **SSH Login:** `on_user_login` scripts when users SSH in
- **Custom Entry:** `on_entry` override for container startup

### Environment Variable Substitution
- Docker Compose-style syntax: `${VAR:-default}`
- Applied throughout all configuration files
- Enables deployment-specific customization

This depth-3 analysis focuses on the essential structure and key components while providing specific details about classes, functions, and architectural patterns that drive the PeiDocker system.