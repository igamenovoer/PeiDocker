# Bug Report: Boolean Case Sensitivity Causes User Creation Failure

## Summary
Boolean values in `merged.env` use Python-style capitalization (`True`/`False`), while shell scripts expect lowercase (`true`/`false`). This mismatch causes critical setup scripts to exit prematurely, resulting in build failures.

## Severity
**CRITICAL** - Prevents successful Docker image build with `--no-cache` flag

## Environment
- Build script: `dockers/build-merged.sh`
- Configuration: `dockers/merged.env`
- Dockerfile: `dockers/merged.Dockerfile`
- Build flags: `--no-cache --progress=plain`

## Symptoms
```
Error: no user 'me'
```

Build fails during stage-2 custom installation scripts that attempt to install packages for user 'me'.

## Root Cause Analysis

### 1. Configuration Format Mismatch

**File: `dockers/merged.env`**
```bash
# Line 19 - Uses capitalized boolean
WITH_SSH='True'

# Other affected lines:
WITH_ESSENTIAL_APPS='True'      # Line 16, 74
KEEP_APT_SOURCE_FILE='True'     # Line 28
APT_KEEP_PROXY='False'          # Line 34
ENABLE_GLOBAL_PROXY='False'     # Line 43, 104
REMOVE_GLOBAL_PROXY_AFTER_BUILD='False'  # Line 46, 107
```

### 2. Script Check Fails

**File: `installation/stage-1/internals/setup-ssh.sh` (line 4)**
```bash
if [ "$WITH_SSH" != "true" ]; then
  exit 0
fi
```

**Behavior:**
- `WITH_SSH='True'` (from env)
- Check evaluates: `'True' != 'true'` → **TRUE**
- Script exits immediately → **User 'me' never created**

### 3. Cascade Failure

**File: `installation/stage-2/generated/_custom-on-build.sh`**
```bash
# Lines 3-7 - All require user 'me' to exist
bash .../install-pixi.bash --user me ...
bash .../install-uv.sh --pypi-repo tuna --user me
bash .../install-nvm-nodejs.sh --with-cn-mirror --user me
bash .../install-codex-cli.sh --user me
bash .../install-claude-code.sh --user me
```

Since user 'me' was never created in stage-1, all these scripts fail.

### 4. Why It Works Sometimes

The issue may not manifest if:
- Docker cache is used (user created in cached stage-1 layer)
- `WITH_SSH` is manually set to lowercase `true`
- Scripts are run in a different order/context

## Impact

### Primary Impact
- **Build fails completely** with `--no-cache` flag
- Prevents clean builds and CI/CD integration
- Blocks new environment setup

### Secondary Impact
- Other boolean flags may be silently ignored:
  - `WITH_ESSENTIAL_APPS` - Essential tools not installed
  - `ENABLE_GLOBAL_PROXY` - Proxy settings ignored
  - `KEEP_APT_SOURCE_FILE` - APT sources incorrectly handled

## Affected Files

### Configuration Files
- `dockers/merged.env` (lines 16, 19, 28, 34, 43, 46, 74, 104, 107)

### Scripts with Boolean Checks
- `installation/stage-1/internals/setup-ssh.sh:4` - Checks `WITH_SSH != "true"`
- `installation/stage-1/internals/install-essentials.sh` - Likely checks `WITH_ESSENTIAL_APPS`
- `installation/stage-2/internals/install-essentials.sh` - May check boolean flags
- Other scripts that parse `ENABLE_GLOBAL_PROXY`, `APT_USE_PROXY`, etc.

### Dependent Configuration
- `dockers/user_config.yml` - Defines SSH user 'me' with expectation it will be created

## Reproduction Steps

1. Start with clean Docker environment (no cached layers):
   ```bash
   docker system prune -a
   ```

2. Run build with no-cache flag:
   ```bash
   cd dockers
   bash build-merged.sh --no-cache --progress=plain
   ```

3. Observe failure during stage-2 custom installations:
   ```
   Step XX/YY : RUN --mount=type=cache,target=/var/cache/apt,sharing=locked
   $PEI_STAGE_DIR_2/internals/custom-on-build.sh
   ...
   bash: line X: user 'me' does not exist
   ```

## Fix Recommendations

### Option 1: Fix Configuration (Recommended)
**Change all boolean values in `merged.env` to lowercase**

```diff
- WITH_ESSENTIAL_APPS='True'
+ WITH_ESSENTIAL_APPS='true'

- WITH_SSH='True'
+ WITH_SSH='true'

- KEEP_APT_SOURCE_FILE='True'
+ KEEP_APT_SOURCE_FILE='true'

- APT_KEEP_PROXY='False'
+ APT_KEEP_PROXY='false'

- ENABLE_GLOBAL_PROXY='False'
+ ENABLE_GLOBAL_PROXY='false'

- REMOVE_GLOBAL_PROXY_AFTER_BUILD='False'
+ REMOVE_GLOBAL_PROXY_AFTER_BUILD='false'
```

**Pros:**
- Follows shell scripting conventions
- Minimal changes required
- No risk of breaking existing scripts

**Cons:**
- May be regenerated by configuration tool
- Need to ensure generator produces lowercase

### Option 2: Fix Scripts (Case-Insensitive Checks)
**Make all boolean checks case-insensitive**

```bash
# Before:
if [ "$WITH_SSH" != "true" ]; then

# After:
if [ "${WITH_SSH,,}" != "true" ]; then  # Bash 4+
# OR
if ! echo "$WITH_SSH" | grep -iq "^true$"; then
```

**Pros:**
- More robust to configuration variations
- Handles both formats

**Cons:**
- More changes required across multiple scripts
- Bash 4+ required for `${VAR,,}` syntax
- More complex logic

### Option 3: Normalization Layer
**Add normalization in setup-env.sh**

```bash
# In installation/stage-*/internals/setup-env.sh
# Normalize boolean values to lowercase
WITH_SSH=$(echo "$WITH_SSH" | tr '[:upper:]' '[:lower:]')
WITH_ESSENTIAL_APPS=$(echo "$WITH_ESSENTIAL_APPS" | tr '[:upper:]' '[:lower:]')
ENABLE_GLOBAL_PROXY=$(echo "$ENABLE_GLOBAL_PROXY" | tr '[:upper:]' '[:lower:]')
# ... etc
export WITH_SSH WITH_ESSENTIAL_APPS ENABLE_GLOBAL_PROXY
```

**Pros:**
- Single point of normalization
- Handles any case variation
- No script changes needed

**Cons:**
- Must catch all boolean variables
- Easy to miss new variables

## Recommended Solution

**Implement Option 1 + Option 3 (Defense in Depth)**

1. Fix `merged.env` to use lowercase (immediate fix)
2. Add normalization in `setup-env.sh` (prevent future issues)
3. Add validation/warning if uppercase detected
4. Update configuration generator (if exists) to produce lowercase

## Testing Checklist

After fix:
- [ ] Build succeeds with `--no-cache --progress=plain`
- [ ] User 'me' is created in stage-1
- [ ] SSH service is configured and enabled
- [ ] Stage-2 custom scripts execute successfully
- [ ] All boolean flags work correctly:
  - [ ] `WITH_SSH`
  - [ ] `WITH_ESSENTIAL_APPS`
  - [ ] `ENABLE_GLOBAL_PROXY`
  - [ ] `KEEP_APT_SOURCE_FILE`
  - [ ] `APT_USE_PROXY`
- [ ] Build works with and without cache
- [ ] Container starts and SSH works: `ssh me@localhost -p 40012`

## Related Issues

- Check if `pei-docker-cli configure --with-merged` generates uppercase booleans
- Verify YAML parser in configuration tool respects case
- Review other shell scripts for similar boolean checks

## References

- Discovered during: Build with `--no-cache --progress=plain`
- Related files:
  - `dockers/build-merged.sh:21-23` (sources merged.env)
  - `dockers/merged.Dockerfile:4,10,19` (uses WITH_SSH, WITH_ESSENTIAL_APPS)
  - `installation/stage-1/internals/setup-ssh.sh:4` (fails silently)
  - `installation/stage-2/generated/_custom-on-build.sh:3-7` (requires user 'me')

## Date
2025-11-07

## Reporter
Identified during Docker build troubleshooting with `--no-cache` flag
