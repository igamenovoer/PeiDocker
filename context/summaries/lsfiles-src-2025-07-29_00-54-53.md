# File Documentation: src Directory

Generated on: 2025-07-29 00:54:53

## Directory Tree

```
src/
└── pei_docker/
    ├── __init__.py
    ├── _version.py
    ├── config_processor.py
    ├── pei.py
    ├── pei_utils.py
    ├── user_config.py
    ├── examples/
    │   ├── environment-variables.yml
    │   ├── gpu-with-host-mount.yml
    │   ├── gpu-with-opengl-win32.yml
    │   ├── invoke-ai-by-pip.yml
    │   ├── minimal-ubuntu-ssh.yml
    │   ├── mount-arbitrary-vol.yml
    │   ├── mount-external-docker-vol.yml
    │   ├── pixi-basic-cpu.yml
    │   ├── pixi-ml-gpu.yml
    │   ├── pixi-with-volumes.yml
    │   ├── python-with-opengl.yml
    │   ├── ssh-keys-inline.yml
    │   ├── with-everything.yml
    │   ├── with-proxy-across-stages.yml
    │   ├── with-proxy-in-build.yml
    │   ├── with-proxy-in-run.yml
    │   └── with-proxy-manually.yml
    ├── gui/
    │   ├── README.md
    │   ├── __init__.py
    │   ├── app.py
    │   ├── models/
    │   │   ├── __init__.py
    │   │   └── config.py
    │   ├── screens/
    │   │   ├── __init__.py
    │   │   ├── project_setup.py
    │   │   ├── startup.py
    │   │   ├── common/
    │   │   │   └── __init__.py
    │   │   └── simple/
    │   │       ├── __init__.py
    │   │       ├── apt_config.py
    │   │       ├── custom_scripts.py
    │   │       ├── device_config.py
    │   │       ├── entry_point.py
    │   │       ├── env_vars.py
    │   │       ├── mounts.py
    │   │       ├── port_mapping.py
    │   │       ├── project_info.py
    │   │       ├── proxy_config.py
    │   │       ├── ssh_config.py
    │   │       ├── summary.py
    │   │       └── wizard.py
    │   ├── utils/
    │   │   ├── __init__.py
    │   │   ├── docker_utils.py
    │   │   └── file_utils.py
    │   └── widgets/
    │       ├── __init__.py
    │       ├── dialogs.py
    │       ├── forms.py
    │       └── inputs.py
    ├── project_files/
    │   ├── stage-1.Dockerfile
    │   ├── stage-2.Dockerfile
    │   └── installation/
    │       ├── stage-1/
    │       │   ├── custom/
    │       │   ├── generated/
    │       │   ├── internals/
    │       │   └── system/
    │       └── stage-2/
    │           ├── custom/
    │           ├── generated/
    │           ├── internals/
    │           ├── system/
    │           └── utilities/
    └── templates/
        ├── base-image-gen.yml
        └── config-template-full.yml
```

## File Descriptions

### Root Package Files

#### `__init__.py`
- **Purpose**: Package initialization and documentation
- **Content**: Comprehensive package documentation describing PeiDocker's architecture, features, and usage patterns
- **Key Features**: 
  - Configuration-driven Docker container creation
  - Two-stage build architecture
  - Environment variable substitution
  - Storage strategy abstraction

#### `_version.py`
- **Purpose**: Version information for the package
- **Content**: Contains version string and metadata for package distribution

#### `config_processor.py` (1,109 lines)
- **Purpose**: Main configuration processing engine
- **Key Classes**:
  - `PeiConfigProcessor`: Orchestrates configuration transformation
  - `StoragePrefixes`: Defines storage volume prefixes (App, Data, Workspace)
  - `StorageTypes`: Defines storage types (volume, host mount, in-image)
- **Functions**: Processes user YAML configs and generates Docker Compose files

#### `pei.py` (630 lines)
- **Purpose**: Primary command-line interface
- **Key Functions**:
  - `main()`: Entry point for CLI commands
  - `create_project()`: Creates new project structure
  - `configure_project()`: Generates docker-compose.yml
  - `remove_project()`: Cleans up Docker resources
- **Features**: Environment variable substitution, safety checks, confirmation prompts

#### `pei_utils.py`
- **Purpose**: Utility functions and helpers
- **Content**: Common utilities used across the codebase

#### `user_config.py` (1,236 lines)
- **Purpose**: Type-safe configuration data structures
- **Key Classes**:
  - `UserConfig`: Main configuration container
  - `StageConfig`: Stage-specific configuration
  - `SSHConfig`: SSH server and authentication settings
  - `ProxyConfig`: HTTP proxy configuration
  - `AptConfig`: APT repository mirror settings
  - `DeviceConfig`: Hardware configuration (CPU/GPU)
  - `CustomScriptConfig`: Lifecycle hook scripts
- **Features**: attrs-based validation, format conversion, SSH key validation

### Examples Directory

Contains 17 YAML configuration examples demonstrating various use cases:

#### Environment and Variables
- `environment-variables.yml`: Environment variable configuration examples
- `ssh-keys-inline.yml`: SSH key configuration with inline key definitions

#### GPU and Graphics
- `gpu-with-host-mount.yml`: GPU access with host directory mounting
- `gpu-with-opengl-win32.yml`: OpenGL support on Windows/WSL2
- `python-with-opengl.yml`: Python environment with OpenGL support

#### Package Management
- `pixi-basic-cpu.yml`: Basic Pixi package manager setup for CPU
- `pixi-ml-gpu.yml`: Machine learning environment with GPU support
- `pixi-with-volumes.yml`: Pixi with persistent volume configuration
- `invoke-ai-by-pip.yml`: InvokeAI installation via pip

#### Storage and Mounting
- `mount-arbitrary-vol.yml`: Custom volume mounting examples
- `mount-external-docker-vol.yml`: External Docker volume integration

#### Network and Proxy
- `with-proxy-across-stages.yml`: Proxy configuration across build stages
- `with-proxy-in-build.yml`: Proxy settings for build stage only
- `with-proxy-in-run.yml`: Proxy settings for runtime only
- `with-proxy-manually.yml`: Manual proxy configuration

#### Complete Examples
- `minimal-ubuntu-ssh.yml`: Minimal Ubuntu setup with SSH access
- `with-everything.yml`: Comprehensive example with all features

### GUI Package

#### Core Application
- `gui/app.py` (473 lines)
  - **Purpose**: Main GUI application entry point
  - **Key Classes**: 
    - `PeiDockerApp`: Main Textual application
    - Command-line interface for GUI modes (start, dev)
  - **Features**: Screen-based navigation, wizard-style configuration

#### Data Models
- `gui/models/config.py`
  - **Purpose**: Configuration data models for GUI
  - **Content**: GUI-specific configuration structures and validation

#### Screens Package

##### Main Screens
- `gui/screens/startup.py`
  - **Purpose**: Application startup and system validation screen
  - **Screen ID**: SC-0

- `gui/screens/project_setup.py`
  - **Purpose**: Project directory selection and setup screen
  - **Screen ID**: SC-1

##### Simple Mode Wizard Screens
- `gui/screens/simple/wizard.py` (281 lines)
  - **Purpose**: Main wizard controller for simple mode
  - **Key Classes**: 
    - `SimpleWizardScreen`: Main controller
    - `WizardStep`: Individual step representation
  - **Screen ID**: SC-2

- `gui/screens/simple/project_info.py`
  - **Purpose**: Project information configuration (name, description)
  - **Screen ID**: SC-3

- `gui/screens/simple/apt_config.py`
  - **Purpose**: APT repository mirror configuration
  - **Screen ID**: SC-4

- `gui/screens/simple/device_config.py`
  - **Purpose**: Hardware device configuration (CPU/GPU)
  - **Screen ID**: SC-5

- `gui/screens/simple/proxy_config.py`
  - **Purpose**: HTTP proxy settings configuration
  - **Screen ID**: SC-6

- `gui/screens/simple/ssh_config.py`
  - **Purpose**: SSH server and authentication configuration
  - **Screen ID**: SC-7

- `gui/screens/simple/port_mapping.py`
  - **Purpose**: Container port mapping configuration
  - **Screen ID**: SC-8

- `gui/screens/simple/env_vars.py`
  - **Purpose**: Environment variables configuration
  - **Screen ID**: SC-9

- `gui/screens/simple/mounts.py`
  - **Purpose**: Volume and mount point configuration
  - **Screen ID**: SC-10

- `gui/screens/simple/custom_scripts.py`
  - **Purpose**: Custom script lifecycle hooks configuration
  - **Screen ID**: SC-11

- `gui/screens/simple/entry_point.py`
  - **Purpose**: Container entry point and command configuration
  - **Screen ID**: SC-12

- `gui/screens/simple/summary.py`
  - **Purpose**: Configuration summary and final review
  - **Screen ID**: SC-13

#### Utilities Package
- `gui/utils/docker_utils.py`
  - **Purpose**: Docker-related utility functions for GUI
  - **Content**: Docker command helpers, status checking

- `gui/utils/file_utils.py`
  - **Purpose**: File system utilities for GUI operations
  - **Content**: Path validation, directory creation, file operations

#### Widgets Package
- `gui/widgets/dialogs.py` (293 lines)
  - **Purpose**: Modal dialog components
  - **Key Classes**:
    - `ErrorDialog`: Error message display
    - `ConfirmDialog`: Confirmation prompts
    - `DirectoryPicker`: Directory selection dialog

- `gui/widgets/forms.py`
  - **Purpose**: Form components and input groups
  - **Content**: Structured form layouts for configuration screens

- `gui/widgets/inputs.py`
  - **Purpose**: Custom input widgets
  - **Content**: Specialized input components for configuration values

### Project Files

#### Docker Templates
- `project_files/stage-1.Dockerfile`
  - **Purpose**: Template for Stage 1 Docker build (system setup)
  - **Content**: Base image, SSH, proxy, APT configuration

- `project_files/stage-2.Dockerfile`
  - **Purpose**: Template for Stage 2 Docker build (application setup)
  - **Content**: Custom mounts, scripts, entry points

#### Installation Scripts Structure
- `project_files/installation/stage-1/`
  - `custom/`: User-defined custom scripts for stage 1
  - `generated/`: Auto-generated scripts from configuration
  - `internals/`: Internal framework scripts
  - `system/`: System-level installation scripts

- `project_files/installation/stage-2/`
  - `custom/`: User-defined custom scripts for stage 2
  - `generated/`: Auto-generated scripts from configuration
  - `internals/`: Internal framework scripts
  - `system/`: System-level installation scripts
  - `utilities/`: Utility scripts for stage 2

### Templates

#### `templates/base-image-gen.yml`
- **Purpose**: Template for base image generation configuration
- **Content**: Base image selection and configuration parameters

#### `templates/config-template-full.yml`
- **Purpose**: Complete configuration template with all options
- **Content**: Comprehensive template showing all available configuration options

## Key Architecture Patterns

### Two-Stage Build System
- **Stage 1**: System-level configuration (SSH, proxy, APT, base packages)
- **Stage 2**: Application-level configuration (custom scripts, mounts, entry points)

### Configuration Flow
1. User creates YAML configuration using templates or GUI
2. `config_processor.py` transforms user config into Docker Compose
3. Docker builds using stage-1 and stage-2 Dockerfiles
4. Installation scripts execute in defined order (system → generated → custom)

### Storage Abstraction
- `/soft/app` → symbolic link to actual storage location
- `/soft/data` → symbolic link to actual storage location  
- `/soft/workspace` → symbolic link to actual storage location
- Supports Docker volumes, host mounts, and in-image storage

### GUI Architecture
- Textual-based terminal UI with screen navigation
- Wizard-style configuration with 14 screens (SC-0 through SC-13)
- Configuration kept in memory until explicitly saved
- Modal dialogs for user interaction and error handling
