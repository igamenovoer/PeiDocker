# PeiDocker Source Directory Documentation

**Generated:** 2025-07-23 14:30:00  
**Directory:** `src\`  
**Purpose:** Source code documentation and file structure analysis

## Overview

The `src\` directory contains the complete PeiDocker source code, organized as a Python package that transforms YAML configurations into reproducible Docker containerized environments. The architecture follows a sophisticated two-stage build system with both CLI and GUI interfaces.

## File Tree Structure

```
src\
├── pei_docker.egg-info\           # Python package metadata (auto-generated)
│   ├── PKG-INFO                   # Package information
│   ├── SOURCES.txt                # Source file list
│   ├── dependency_links.txt       # Dependency links
│   ├── entry_points.txt           # CLI entry points
│   ├── requires.txt               # Package requirements
│   └── top_level.txt              # Top-level package names
│
└── pei_docker\                    # Main Python package
    ├── __init__.py                # Package initialization with version info
    ├── _version.py                # Auto-generated version information (setuptools-scm)
    ├── config_processor.py        # Core configuration processing engine
    ├── pei.py                     # CLI entry point with Click commands
    ├── pei_utils.py               # Utilities for environment variable substitution
    ├── user_config.py             # Data models using attrs for type-safe configuration
    │
    ├── examples\                  # Example configuration files
    │   ├── environment-variables.yml
    │   ├── gpu-with-host-mount.yml
    │   ├── gpu-with-opengl-win32.yml
    │   ├── invoke-ai-by-pip.yml
    │   ├── minimal-ubuntu-ssh.yml
    │   ├── mount-arbitrary-vol.yml
    │   ├── mount-external-docker-vol.yml
    │   ├── pixi-basic-cpu.yml
    │   ├── pixi-ml-gpu.yml
    │   ├── pixi-with-volumes.yml
    │   ├── python-with-opengl.yml
    │   ├── ssh-keys-inline.yml
    │   ├── with-everything.yml
    │   ├── with-proxy-across-stages.yml
    │   ├── with-proxy-in-build.yml
    │   ├── with-proxy-in-run.yml
    │   └── with-proxy-manually.yml
    │
    ├── gui\                       # Terminal User Interface (TUI) module
    │   ├── README.md              # GUI module documentation
    │   ├── __init__.py            # GUI package initialization
    │   ├── app.py                 # Main Textual app with PeiDockerApp class
    │   │
    │   ├── models\                # GUI data models
    │   │   ├── __init__.py        # Models package initialization
    │   │   └── config.py          # GUI configuration models using dataclasses
    │   │
    │   ├── screens\               # Textual screen implementations
    │   │   ├── __init__.py        # Screens package initialization
    │   │   ├── mode_selection.py  # Mode selection screen (simple/advanced)
    │   │   ├── startup.py         # Application startup screen
    │   │   │
    │   │   ├── common\            # Common screen components
    │   │   │   └── __init__.py    # Common components initialization
    │   │   │
    │   │   └── simple\            # Simple mode wizard screens
    │   │       ├── __init__.py    # Simple screens initialization
    │   │       ├── apt_config.py  # APT repository mirror configuration
    │   │       ├── custom_scripts.py  # Custom script configuration
    │   │       ├── device_config.py   # GPU/hardware device configuration
    │   │       ├── entry_point.py     # Custom entry point configuration
    │   │       ├── env_vars.py        # Environment variables configuration
    │   │       ├── mounts.py          # Volume and mount configuration
    │   │       ├── port_mapping.py    # Port mapping configuration
    │   │       ├── project_info.py    # Project information and base image
    │   │       ├── proxy_config.py    # Proxy configuration
    │   │       ├── ssh_config.py      # SSH access configuration
    │   │       ├── summary.py         # Configuration summary screen
    │   │       └── wizard.py          # Main wizard orchestration
    │   │
    │   ├── utils\                 # GUI utility modules
    │   │   ├── __init__.py        # Utils package initialization
    │   │   ├── docker_utils.py    # Docker availability and version checking
    │   │   └── file_utils.py      # File operations and YAML configuration saving
    │   │
    │   └── widgets\               # Custom Textual widgets
    │       ├── __init__.py        # Widgets package initialization
    │       ├── dialogs.py         # Dialog widgets for user interaction
    │       ├── forms.py           # Form widgets for data input
    │       └── inputs.py          # Specialized input widgets
    │
    ├── project_files\             # Template files for Docker project generation
    │   ├── stage-1.Dockerfile     # Stage 1 Dockerfile template
    │   ├── stage-2.Dockerfile     # Stage 2 Dockerfile template
    │   │
    │   └── installation\          # Container installation scripts and templates
    │       ├── stage-1\           # Stage 1 installation files
    │       │   ├── custom\        # User customizable scripts
    │       │   ├── generated\     # Auto-generated script aggregators
    │       │   ├── internals\     # Internal system scripts
    │       │   ├── system\        # System-level installation scripts
    │       │   └── tmp\           # Temporary files directory
    │       │
    │       └── stage-2\           # Stage 2 installation files
    │           ├── custom\        # User customizable scripts
    │           ├── generated\     # Auto-generated script aggregators
    │           ├── internals\     # Internal system scripts
    │           ├── system\        # System-level installation scripts
    │           ├── tmp\           # Temporary files directory
    │           └── utilities\     # Utility installation scripts
    │
    └── templates\                 # Configuration templates
        ├── base-image-gen.yml     # Docker Compose template for image generation
        └── config-template-full.yml  # Complete user configuration template
```

## Core Files Analysis

### Main Package Files

#### `__init__.py`
- **Purpose:** Package initialization and version management
- **Key Components:**
  - Version detection using `importlib.metadata`
  - Fallback version (`0.1.0`) for development
  - `__all__` export list for clean API

#### `_version.py`
- **Purpose:** Auto-generated version information by setuptools-scm
- **Key Components:**
  - Version string and tuple definitions
  - Current version: `0.1.dev203+g1109656.d20250723`
  - Type checking support for version tuples

#### `config_processor.py`
- **Purpose:** Core configuration transformation engine
- **Key Classes:**
  - `PeiConfigProcessor`: Main processing class with 935+ lines
  - `StoragePrefixes`: Storage path constants (`app`, `data`, `workspace`)
  - `StoragePaths`: Container path mapping (`/soft`, `/hard/image`, `/hard/volume`)
  - `Defaults`: System-wide default values and constants
  - `GeneratedScripts`: Script generation configuration
- **Key Methods:**
  - `process()`: Main configuration processing pipeline
  - `_process_config_and_apply_x_compose()`: Apply user config to compose template
  - `_apply_ssh_to_x_compose()`: SSH configuration processing
  - `_apply_proxy()`: Proxy configuration processing
  - `_apply_apt()`: APT repository configuration
  - `_generate_script_files()`: Custom script file generation
  - `_process_public_key_sources()`: SSH public key processing with ~ expansion
  - `_process_private_key_sources()`: SSH private key processing with ~ expansion

#### `pei.py`
- **Purpose:** CLI entry point using Click framework
- **Key Functions:**
  - `create`: Project initialization with template copying
  - `configure`: YAML to docker-compose.yml transformation
  - `remove`: Docker image and container cleanup
  - Docker container management utilities
- **Key Features:**
  - Interactive confirmation prompts
  - Docker container lifecycle management
  - Error handling and logging

#### `user_config.py`
- **Purpose:** Type-safe configuration data models using attrs
- **Key Classes:**
  - `UserConfig`: Top-level configuration container
  - `StageConfig`: Per-stage configuration (stage-1, stage-2)
  - `ImageConfig`: Docker image configuration
  - `SSHConfig`/`SSHUserConfig`: SSH access configuration
  - `ProxyConfig`: Proxy server configuration
  - `AptConfig`: APT repository configuration
  - `DeviceConfig`: Hardware device configuration
  - `CustomScriptConfig`: Custom script lifecycle hooks
  - `StorageOption`: Storage configuration with validation
- **Key Features:**
  - Attrs-based validation and type checking
  - Port mapping utilities (`port_mapping_str_to_dict`, `port_mapping_dict_to_str`)
  - Environment variable conversion (`env_str_to_dict`, `env_dict_to_str`)
  - SSH key format validation

#### `pei_utils.py`
- **Purpose:** Environment variable substitution and SSH key utilities
- **Key Functions:**
  - `substitute_env_vars()`: Docker Compose-style `${VAR:-default}` syntax
  - `process_config_env_substitution()`: Recursive config processing
  - SSH key utilities: generation, validation, type detection
  - `find_system_ssh_key()`: Auto-discovery with priority order
  - `resolve_ssh_key_path()`: Absolute path and ~ expansion handling
  - `write_ssh_key_to_temp_file()`: Temporary SSH key file management

### GUI Module

#### `gui/app.py`
- **Purpose:** Main Textual application entry point
- **Key Classes:**
  - `PeiDockerApp`: Main application class extending Textual App
- **Key Features:**
  - Project directory management
  - Docker availability checking
  - Screen navigation and lifecycle management
  - CLI argument parsing with `--project-dir` support

#### `gui/models/config.py`
- **Purpose:** GUI-specific configuration data models
- **Key Classes:**
  - `ProjectConfig`: Complete project configuration
  - `Stage1Config`/`Stage2Config`: Stage-specific configurations
  - `SSHConfig`/`SSHUser`: SSH configuration models
  - `ProxyConfig`, `DeviceConfig`, `MountConfig`: Component configurations
- **Key Methods:**
  - `to_user_config_dict()`: Convert GUI models to user_config.yml format

#### `gui/screens/simple/wizard.py`
- **Purpose:** Main wizard orchestration for simple mode
- **Key Features:**
  - Step-by-step configuration flow
  - Screen navigation with back/forward
  - Configuration data persistence
  - Integration with all wizard step screens

#### `gui/screens/simple/` (Wizard Step Screens)
- **`project_info.py`**: Base image and project name configuration
- **`ssh_config.py`**: SSH users, authentication, and access configuration
- **`proxy_config.py`**: HTTP proxy settings for build and runtime
- **`apt_config.py`**: APT repository mirror selection (tuna, aliyun, etc.)
- **`port_mapping.py`**: Additional port forwarding configuration
- **`env_vars.py`**: Environment variable management
- **`device_config.py`**: GPU/hardware device configuration
- **`mounts.py`**: Volume and mount point configuration
- **`entry_point.py`**: Custom entry point script configuration
- **`custom_scripts.py`**: Lifecycle hook script configuration
- **`summary.py`**: Final configuration review and YAML generation

#### `gui/utils/`
- **`docker_utils.py`**: Docker availability checking and image validation
- **`file_utils.py`**: File operations, directory creation, YAML saving

#### `gui/widgets/`
- **`inputs.py`**: Specialized input widgets for complex data types
- **`forms.py`**: Form layout and validation widgets
- **`dialogs.py`**: Error dialogs and user interaction widgets

### Project Files Structure

#### `project_files/installation/`
- **Purpose:** Container installation script templates
- **Organization:**
  - `stage-1/` and `stage-2/` directories for two-stage architecture
  - `custom/`: User-customizable scripts for lifecycle hooks
  - `generated/`: Auto-generated script aggregators
  - `internals/`: Core system scripts for container setup
  - `system/`: Specialized installation scripts (apt, conda, pixi, etc.)

#### Key Installation Components:
- **SSH Setup**: User creation, key management, server configuration
- **Proxy Management**: Selective proxy usage for build/runtime
- **Package Management**: APT sources, conda/pixi environments
- **Development Tools**: OpenGL, CUDA, ROS2, Node.js, Python environments
- **Storage Management**: Symbolic link creation for flexible storage strategy

### Templates

#### `templates/config-template-full.yml`
- **Purpose:** Complete user configuration template
- **Features:** Comprehensive example with all available options

#### `templates/base-image-gen.yml`
- **Purpose:** Docker Compose template for image generation
- **Features:** Two-stage build configuration with variable substitution

## Architecture Highlights

### Two-Stage Build System
1. **Stage 1**: System foundation (base image, SSH, system packages)
2. **Stage 2**: Application layer (user data, workspace, app-specific setup)

### Intelligent Storage Strategy
- Flexible path abstraction through symbolic links
- Automatic switching between external volumes and in-image storage
- Path mapping: `/soft` → `/hard/volume` or `/hard/image`

### Configuration Processing Pipeline
1. User YAML configuration input
2. Environment variable substitution (`${VAR:-default}`)
3. Type-safe model validation
4. Docker Compose template transformation
5. Custom script generation
6. File system preparation

### Key Design Patterns
- **Configuration-driven**: Everything controlled through YAML
- **Environment variable substitution**: Docker Compose compatibility
- **Cross-platform support**: Windows (WSL), Linux, macOS
- **Extensible lifecycle hooks**: Custom scripts for build/runtime events
- **Professional SSH management**: Multiple authentication methods, key discovery

This documentation provides a comprehensive overview of the PeiDocker source code structure, highlighting the sophisticated architecture that enables configuration-driven Docker automation with both CLI and GUI interfaces.