# File Structure Documentation: src/ Directory

Generated on: 2025-07-31 04:55:06

## Directory Tree Overview

```
src/
└── pei_docker/
    ├── __init__.py
    ├── _version.py
    ├── config_processor.py
    ├── pei.py
    ├── pei_utils.py
    ├── user_config.py
    ├── examples/               # YAML configuration examples (13 files)
    ├── gui/                    # Textual-based GUI application
    ├── project_files/          # Template files for Docker projects
    ├── templates/              # Configuration templates
    └── webgui/                 # Web-based GUI (placeholder)
```

## Core Module Files

### Main Entry Points
- **`pei.py`** - Main CLI entry point for PeiDocker commands
  - Contains primary command-line interface
  - Handles `create`, `configure`, and other CLI operations
  
- **`__init__.py`** - Package initialization file
  - Defines package imports and version
  
- **`_version.py`** - Version information
  - Contains package version string

### Core Functionality
- **`config_processor.py`** - Configuration processing engine
  - Handles YAML configuration parsing and validation
  - Processes user_config.yml into Docker build context
  - Manages environment variable substitution
  
- **`pei_utils.py`** - Utility functions
  - Common helper functions used across the application
  - File operations, path handling, system utilities
  
- **`user_config.py`** - Configuration data structures
  - Defines configuration classes and data models
  - Handles configuration validation and defaults

## Examples Directory (13 files)
Configuration examples demonstrating various PeiDocker use cases:

### Basic Examples
- **`minimal-ubuntu-ssh.yml`** - Minimal Ubuntu setup with SSH access
- **`environment-variables.yml`** - Environment variable configuration demo
- **`ssh-keys-inline.yml`** - SSH key configuration with inline keys

### GPU and Graphics Examples  
- **`gpu-with-host-mount.yml`** - GPU setup with host directory mounting
- **`gpu-with-opengl-win32.yml`** - GPU with OpenGL support for Windows
- **`python-with-opengl.yml`** - Python development with OpenGL

### Volume and Storage Examples
- **`mount-arbitrary-vol.yml`** - Custom volume mounting
- **`mount-external-docker-vol.yml`** - External Docker volume integration
- **`pixi-with-volumes.yml`** - Pixi package manager with volume persistence

### Development Environment Examples
- **`pixi-basic-cpu.yml`** - Basic CPU-only Pixi environment
- **`pixi-ml-gpu.yml`** - Machine learning environment with GPU support
- **`invoke-ai-by-pip.yml`** - InvokeAI installation via pip

### Proxy Configuration Examples
- **`with-proxy-across-stages.yml`** - Proxy configuration for both build stages
- **`with-proxy-in-build.yml`** - Proxy only during build phase
- **`with-proxy-in-run.yml`** - Proxy only during runtime
- **`with-proxy-manually.yml`** - Manual proxy configuration

### Comprehensive Example
- **`with-everything.yml`** - Complete example showcasing all PeiDocker features

## GUI Directory Structure

### Main Application
- **`README.md`** - GUI documentation and usage instructions
- **`__init__.py`** - GUI package initialization
- **`app.py`** - Main Textual application class (PeiDockerApp)
  - Application entry point and screen management
  - Navigation between different configuration screens

### Models
- **`models/config.py`** - Configuration data models for GUI
  - Pydantic models for form validation
  - Data structures for GUI state management

### Screens
- **`screens/__init__.py`** - Screen package initialization
- **`screens/startup.py`** - Welcome and system check screen
- **`screens/project_setup.py`** - Project directory selection screen

#### Common Screens
- **`screens/common/__init__.py`** - Shared screen components

#### Simple Mode Wizard Screens
- **`screens/simple/wizard.py`** - Wizard controller and navigation
- **`screens/simple/project_info.py`** - Project information form
- **`screens/simple/ssh_config.py`** - SSH configuration screen
- **`screens/simple/proxy_config.py`** - Proxy settings configuration
- **`screens/simple/apt_config.py`** - APT repository configuration
- **`screens/simple/port_mapping.py`** - Port mapping configuration
- **`screens/simple/env_vars.py`** - Environment variables setup
- **`screens/simple/device_config.py`** - GPU/device configuration
- **`screens/simple/mounts.py`** - Volume mounting configuration
- **`screens/simple/entry_point.py`** - Custom entry point configuration
- **`screens/simple/custom_scripts.py`** - Custom scripts management
- **`screens/simple/summary.py`** - Final review and save screen

### Utilities
- **`utils/docker_utils.py`** - Docker integration utilities
  - Docker availability checking
  - Container and image management functions
  
- **`utils/file_utils.py`** - File system utilities
  - Cross-platform file operations
  - Project directory management

### Widgets
- **`widgets/dialogs.py`** - Custom dialog components
- **`widgets/forms.py`** - Form input components
- **`widgets/inputs.py`** - Specialized input widgets

## Project Files Directory

Template files and scripts used in generated Docker projects:

### Installation Scripts Structure
```
project_files/installation/
├── stage-1/                 # First build stage files
│   ├── custom/              # User custom scripts (examples)
│   ├── generated/           # Generated wrapper scripts
│   ├── internals/           # Core system scripts
│   └── system/              # System setup scripts
└── stage-2/                 # Second build stage files
    ├── custom/              # User custom scripts (examples)
    ├── generated/           # Generated wrapper scripts
    ├── internals/           # Core system scripts
    └── system/              # System setup scripts
```

### Stage-1 Files

#### Custom Scripts (Examples)
- **`install-dev-tools.sh`** - Development tools installation example
- **`my-build-*.sh`** - Build-time script examples
- **`my-on-every-run-*.sh`** - Every container start script examples
- **`my-on-first-run-*.sh`** - First container start script examples
- **`my-on-user-login-*.sh`** - SSH login script examples

#### Generated Scripts
- **`_custom-on-build.sh`** - Generated build-time script wrapper
- **`_custom-on-every-run.sh`** - Generated every-run script wrapper
- **`_custom-on-first-run.sh`** - Generated first-run script wrapper
- **`_custom-on-user-login.sh`** - Generated login script wrapper

#### Internal Scripts
- **`entrypoint.sh`** - Container entry point script
- **`on-entry.sh`** - Main initialization script
- **`on-every-run.sh`** - Every container start logic
- **`on-first-run.sh`** - First container start logic
- **`setup-ssh.sh`** - SSH service configuration
- **`setup-users.sh`** - User account management
- **`setup-env.sh`** - Environment variable setup
- **`install-essentials.sh`** - Essential packages installation
- **`_setup-cuda.sh`** - CUDA setup if GPU enabled
- **`cleanup.sh`** - Build cleanup operations

#### System Setup Scripts
- **`apt/`** - APT repository and cache management
  - `*-cache.sh` - External/shadow cache control scripts
  - `ubuntu-*.list` - Repository mirror configurations
- **`clang/`** - Clang compiler installation and setup
- **`firefox/`** - Firefox repository setup
- **`proxy/`** - Proxy configuration management
- **`ros2/`** - ROS2 robotics framework setup
- **`ssh/keys/`** - SSH key examples
- **`vision-dev/`** - Computer vision development tools

### Stage-2 Files

#### Custom Scripts (Examples)
- **`install-gui-tools.sh`** - GUI application installation example
- **`install-my-conda.sh`** - Conda environment setup example
- **`test-params-echo.bash`** - Parameter passing test script
- **`my-*.sh`** - Similar lifecycle script examples as Stage-1

#### Generated Scripts
- Similar wrapper scripts as Stage-1, but for Stage-2 context

#### Internal Scripts
- **`create-dirs.sh`** - Stage-2 directory creation
- **`create-links.sh`** - Dynamic storage linking system
- Similar core scripts as Stage-1 with Stage-2 enhancements

#### System Setup Scripts
- **`conda/`** - Conda package manager setup
  - Miniconda/Miniforge installation scripts
  - Repository configuration for Chinese mirrors
- **`invoke-ai/`** - InvokeAI (AI image generation) setup
  - Multiple installation methods (conda, from source)
  - Multi-user session management
- **`magnum/`** - Magnum graphics library installation
- **`nodejs/`** - Node.js and npm ecosystem setup
- **`opencv/`** - OpenCV computer vision library (CPU/CUDA variants)
- **`opengl/`** - OpenGL graphics support setup
- **`pixi/`** - Pixi package manager installation and configuration
- **`utilities/`** - Additional utility installations

### Docker Files
- **`stage-1.Dockerfile`** - First stage Docker build template
- **`stage-2.Dockerfile`** - Second stage Docker build template

## Templates Directory
- **`base-image-gen.yml`** - Base image generation template
- **`config-template-full.yml`** - Complete configuration template with all options
  - Comprehensive example showing every available configuration parameter
  - Used as reference for GUI form generation

## WebGUI Directory
- **`webgui/`** - Placeholder for future web-based GUI implementation
  - Currently empty, planned for NiceGUI-based web interface

## Key Architectural Patterns

### Two-Stage Build System
PeiDocker uses a two-stage Docker build approach:
1. **Stage-1**: Foundation image with system-level setup
2. **Stage-2**: Application image with enhanced features (dynamic storage)

### Script Lifecycle Management
- **Build-time**: `on_build` scripts execute during image creation
- **Runtime**: `on_first_run` (once) and `on_every_run` (always) scripts
- **SSH Login**: `on_user_login` scripts execute when users SSH in
- **Custom Entry**: `on_entry` override for custom container startup

### Dynamic Storage (Stage-2 Feature)
- `/soft/app`, `/soft/data`, `/soft/workspace` directories
- Smart linking to `/hard/volume/` (external) or `/hard/image/` (internal)
- Allows switching storage strategy after build

### Configuration Processing
- YAML-based configuration with environment variable substitution
- Stage inheritance: Stage-2 inherits from Stage-1, can override
- Validation and type checking via Pydantic models

This comprehensive file structure supports both CLI and GUI interfaces for creating sophisticated Docker development environments with advanced features like GPU support, proxy configuration, custom scripts, and flexible storage management.