<div class="tab-title">
    ğŸ“œ Custom Scripts Configuration
</div>
<p class="tab-description">
    Configure custom entry points and lifecycle hook scripts for Stage-1 and Stage-2 sequential image builds.
</p>

<!-- Important Path Access Note -->
<div class="card mb-6 bg-blue-50 border-blue-200">
    <div class="card-header bg-blue-100">
        â„¹ï¸ Important: Script Path Access Rules
    </div>
    <div class="card-content">
        <div class="text-sm">
            <div class="mb-3">
                <strong>ğŸ—ï¸ Stage-1 Scripts:</strong>
                <div class="ml-4 mt-1">
                    â€¢ Can <strong>ONLY</strong> reference paths starting with <code>stage-1/</code><br>
                    â€¢ <strong>Cannot access</strong> any <code>stage-2/</code> paths (stage-2 doesn't exist yet)<br>
                    â€¢ Examples: <code>stage-1/custom/script.sh</code>, <code>stage-1/system/setup.sh</code>
                </div>
            </div>
            <div>
                <strong>ğŸš€ Stage-2 Scripts:</strong>
                <div class="ml-4 mt-1">
                    â€¢ Can reference paths starting with <strong>both</strong> <code>stage-1/</code> and <code>stage-2/</code><br>
                    â€¢ Has access to all stage-1 resources plus stage-2 resources<br>
                    â€¢ Examples: <code>stage-2/custom/app.sh</code>, <code>stage-1/system/base.sh</code>
                </div>
            </div>
            <div class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs">
                <strong>Why?</strong> Stage-1 builds first and becomes the foundation. Stage-2 builds on top of Stage-1, inheriting all its resources.
            </div>
        </div>
    </div>
</div>

<!-- Stage-1 Scripts -->
<div class="card mb-6">
    <div class="card-header">
        ğŸ—ï¸ Stage-1 Image Scripts
    </div>
    <div class="card-content">
        <!-- Custom Entry Point -->
        <div class="form-group">
            <label class="form-label">
                Custom Entry Point
            </label>
            <div class="form-help mb-4">
                Override the default entry point for Stage-1
            </div>
            
            <div class="flex flex-col gap-2 mb-4">
                <label class="flex items-center gap-2">
                    <input type="radio" name="stage1-entry-mode" value="none" checked>
                    <span>Use default</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="radio" name="stage1-entry-mode" value="file">
                    <span>File path</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="radio" name="stage1-entry-mode" value="inline">
                    <span>Inline script</span>
                </label>
            </div>
            
            <div id="stage1-entry-config" style="display: none;">
                <!-- File Path Mode -->
                <div id="stage1-entry-file-mode">
                    <input type="text" class="form-input w-full mb-2" placeholder="stage-1/custom/script-a1b2c3d4.bash --param=value">
                </div>
                <!-- Inline Script Mode -->
                <div id="stage1-entry-inline-mode" style="display: none;">
                    <div class="flex items-center mb-2">
                        <span class="bg-gray-100 px-2 py-1 rounded-l border text-sm font-mono">stage-1/custom/</span>
                        <input type="text" class="form-input rounded-l-none" placeholder="script-a1b2c3d4.bash" style="flex: 1;" readonly>
                    </div>
                    <textarea class="form-textarea w-full" rows="4" placeholder="#!/bin/bash&#10;echo 'Custom entry point'"></textarea>
                </div>
            </div>
        </div>

        <!-- Lifecycle Scripts -->
        <div class="form-group">
            <label class="form-label">
                Lifecycle Scripts
            </label>
            <div class="form-help mb-4">
                Scripts that run at specific lifecycle events
            </div>
            
            <div id="stage1-lifecycle-scripts">
                <div class="mb-4">
                    <div class="form-label text-sm">on_build - Runs during Stage-1 image building</div>
                    <div class="flex gap-2 mb-2">
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage1', 'on_build', 'file')">
                            ğŸ“ Add File
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage1', 'on_build', 'inline')">
                            ğŸ“ Add Inline
                        </button>
                    </div>
                    <div id="stage1-on_build-scripts"></div>
                </div>
                
                <div class="mb-4">
                    <div class="form-label text-sm">on_first_run - Runs on first container start (respective stage)</div>
                    <div class="flex gap-2 mb-2">
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage1', 'on_first_run', 'file')">
                            ğŸ“ Add File
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage1', 'on_first_run', 'inline')">
                            ğŸ“ Add Inline
                        </button>
                    </div>
                    <div id="stage1-on_first_run-scripts"></div>
                </div>
                
                <div class="mb-4">
                    <div class="form-label text-sm">on_every_run - Runs on every container start (respective stage)</div>
                    <div class="flex gap-2 mb-2">
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage1', 'on_every_run', 'file')">
                            ğŸ“ Add File
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage1', 'on_every_run', 'inline')">
                            ğŸ“ Add Inline
                        </button>
                    </div>
                    <div id="stage1-on_every_run-scripts"></div>
                </div>
                
                <div class="mb-4">
                    <div class="form-label text-sm">on_user_login - Runs when user logs in via SSH (respective stage)</div>
                    <div class="flex gap-2 mb-2">
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage1', 'on_user_login', 'file')">
                            ğŸ“ Add File
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage1', 'on_user_login', 'inline')">
                            ğŸ“ Add Inline
                        </button>
                    </div>
                    <div id="stage1-on_user_login-scripts"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stage-2 Scripts -->
<div class="card mb-6">
    <div class="card-header">
        ğŸš€ Stage-2 Image Scripts
    </div>
    <div class="card-content">
        <!-- Custom Entry Point -->
        <div class="form-group">
            <label class="form-label">
                Custom Entry Point
            </label>
            <div class="form-help mb-4">
                Override the default entry point for Stage-2
            </div>
            
            <div class="flex flex-col gap-2 mb-4">
                <label class="flex items-center gap-2">
                    <input type="radio" name="stage2-entry-mode" value="none" checked>
                    <span>Use default</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="radio" name="stage2-entry-mode" value="file">
                    <span>File path</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="radio" name="stage2-entry-mode" value="inline">
                    <span>Inline script</span>
                </label>
            </div>
            
            <div id="stage2-entry-config" style="display: none;">
                <!-- File Path Mode -->
                <div id="stage2-entry-file-mode">
                    <input type="text" class="form-input w-full mb-2" placeholder="stage-2/custom/script-a1b2c3d4.bash --param=value">
                </div>
                <!-- Inline Script Mode -->
                <div id="stage2-entry-inline-mode" style="display: none;">
                    <div class="flex items-center mb-2">
                        <span class="bg-gray-100 px-2 py-1 rounded-l border text-sm font-mono">stage-2/custom/</span>
                        <input type="text" class="form-input rounded-l-none" placeholder="script-a1b2c3d4.bash" style="flex: 1;" readonly>
                    </div>
                    <textarea class="form-textarea w-full" rows="4" placeholder="#!/bin/bash&#10;echo 'Custom entry point'"></textarea>
                </div>
            </div>
        </div>

        <!-- Lifecycle Scripts -->
        <div class="form-group">
            <label class="form-label">
                Lifecycle Scripts
            </label>
            <div class="form-help mb-4">
                Scripts that run at specific lifecycle events
            </div>
            
            <div id="stage2-lifecycle-scripts">
                <div class="mb-4">
                    <div class="form-label text-sm">on_build - Runs during Stage-2 image building</div>
                    <div class="flex gap-2 mb-2">
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage2', 'on_build', 'file')">
                            ğŸ“ Add File
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage2', 'on_build', 'inline')">
                            ğŸ“ Add Inline
                        </button>
                    </div>
                    <div id="stage2-on_build-scripts"></div>
                </div>
                
                <div class="mb-4">
                    <div class="form-label text-sm">on_first_run - Runs on first container start (respective stage)</div>
                    <div class="flex gap-2 mb-2">
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage2', 'on_first_run', 'file')">
                            ğŸ“ Add File
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage2', 'on_first_run', 'inline')">
                            ğŸ“ Add Inline
                        </button>
                    </div>
                    <div id="stage2-on_first_run-scripts"></div>
                </div>
                
                <div class="mb-4">
                    <div class="form-label text-sm">on_every_run - Runs on every container start (respective stage)</div>
                    <div class="flex gap-2 mb-2">
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage2', 'on_every_run', 'file')">
                            ğŸ“ Add File
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage2', 'on_every_run', 'inline')">
                            ğŸ“ Add Inline
                        </button>
                    </div>
                    <div id="stage2-on_every_run-scripts"></div>
                </div>
                
                <div class="mb-4">
                    <div class="form-label text-sm">on_user_login - Runs when user logs in via SSH (respective stage)</div>
                    <div class="flex gap-2 mb-2">
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage2', 'on_user_login', 'file')">
                            ğŸ“ Add File
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="addLifecycleScript('stage2', 'on_user_login', 'inline')">
                            ğŸ“ Add Inline
                        </button>
                    </div>
                    <div id="stage2-on_user_login-scripts"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script Execution Preview -->
<div class="card mt-6">
    <div class="card-header">
        âš¡ Script Execution Order Preview
    </div>
    <div class="card-content">
        <div class="grid grid-2">
            <div>
                <h4 class="form-label mb-2">Stage-1 Execution</h4>
                <div class="preview-panel">
                    <div class="font-mono text-sm">
                        <div class="text-orange-600 font-semibold mb-1">ğŸ—ï¸ Build Time:</div>
                        <div class="ml-2">â€¢ on_build scripts execute</div>
                        <div class="text-blue-600 font-semibold mt-2 mb-1">ğŸš€ Runtime (Container Start):</div>
                        <div class="ml-2">â€¢ on_first_run scripts (first time only)</div>
                        <div class="ml-2">â€¢ on_every_run scripts (every start)</div>
                        <div class="ml-2">â€¢ SSH service starts</div>
                        <div class="ml-2">â€¢ Custom entry point (if configured)</div>
                        <div class="text-green-600 font-semibold mt-2 mb-1">ğŸ‘¤ SSH Login:</div>
                        <div class="ml-2">â€¢ on_user_login scripts execute</div>
                    </div>
                </div>
            </div>
            <div>
                <h4 class="form-label mb-2">Stage-2 Execution</h4>
                <div class="preview-panel">
                    <div class="font-mono text-sm">
                        <div class="text-orange-600 font-semibold mb-1">ğŸ—ï¸ Build Time:</div>
                        <div class="ml-2">â€¢ on_build scripts execute</div>
                        <div class="text-blue-600 font-semibold mt-2 mb-1">ğŸš€ Runtime (Container Start):</div>
                        <div class="ml-2">â€¢ Stage-1 on_first_run + on_every_run</div>
                        <div class="ml-2">â€¢ Dynamic storage links created</div>
                        <div class="ml-2">â€¢ Stage-2 on_first_run (first time only)</div>
                        <div class="ml-2">â€¢ Stage-2 on_every_run (every start)</div>
                        <div class="ml-2">â€¢ SSH service starts</div>
                        <div class="ml-2">â€¢ Custom entry point (Stage-2 > Stage-1)</div>
                        <div class="text-green-600 font-semibold mt-2 mb-1">ğŸ‘¤ SSH Login:</div>
                        <div class="ml-2">â€¢ on_user_login scripts execute</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function generateUUID() {
        return Math.random().toString(36).substr(2, 8);
    }

    function addLifecycleScript(stage, lifecycle, type) {
        const container = document.getElementById(`${stage}-${lifecycle}-scripts`);
        const div = document.createElement('div');
        div.className = 'list-item';
        const uuid = generateUUID();
        
        if (type === 'file') {
            div.innerHTML = `
                <div class="list-item-content w-full">
                    <input type="text" class="form-input w-full mb-2" placeholder="${stage}/custom/script-${uuid}.bash --param=value">
                    <div class="flex gap-2">
                        <button class="btn btn-warning btn-sm" onclick="editFilePath(this)">
                            âœï¸ Edit
                        </button>
                        <button class="btn btn-error btn-sm" onclick="removeScript(this)">
                            ğŸ—‘ï¸ Remove
                        </button>
                    </div>
                </div>
            `;
        } else {
            div.innerHTML = `
                <div class="list-item-content w-full">
                    <div class="flex items-center mb-2">
                        <span class="bg-gray-100 px-2 py-1 rounded-l border text-sm font-mono">${stage}/custom/</span>
                        <input type="text" class="form-input rounded-l-none" value="script-${uuid}.bash" style="flex: 1;" readonly>
                    </div>
                    <textarea class="form-textarea w-full mb-2" rows="3" placeholder="#!/bin/bash&#10;echo 'Inline script content'"></textarea>
                    <div class="flex gap-2">
                        <button class="btn btn-info btn-sm" onclick="viewInlineScript('script-${uuid}.bash')">
                            ğŸ‘ï¸ View
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editInlineScript('script-${uuid}.bash')">
                            âœï¸ Edit
                        </button>
                        <button class="btn btn-error btn-sm" onclick="removeScript(this)">
                            ğŸ—‘ï¸ Remove
                        </button>
                    </div>
                </div>
            `;
        }
        
        container.appendChild(div);
    }

    function removeScript(button) {
        button.closest('.list-item').remove();
    }

    function viewInlineScript(scriptName) {
        alert(`Viewing inline script: ${scriptName}\n\n#!/bin/bash\necho "Setting up development environment"\nexport PATH=$PATH:/usr/local/bin\n# Add more setup commands here`);
    }

    function editInlineScript(scriptName) {
        const newContent = prompt(`Edit inline script: ${scriptName}`, `#!/bin/bash\necho "Setting up development environment"\nexport PATH=$PATH:/usr/local/bin\n# Add more setup commands here`);
        if (newContent !== null) {
            alert(`Script ${scriptName} updated successfully!`);
        }
    }

    function editFilePath(button) {
        const input = button.closest('.list-item').querySelector('input');
        const newPath = prompt('Edit file path:', input.value);
        if (newPath !== null) {
            input.value = newPath;
        }
    }

    // Handle entry point mode changes
    document.addEventListener('change', function(e) {
        if (e.target.name === 'stage1-entry-mode') {
            const config = document.getElementById('stage1-entry-config');
            const fileMode = document.getElementById('stage1-entry-file-mode');
            const inlineMode = document.getElementById('stage1-entry-inline-mode');
            
            if (e.target.value === 'none') {
                config.style.display = 'none';
            } else {
                config.style.display = 'block';
                if (e.target.value === 'file') {
                    fileMode.style.display = 'block';
                    inlineMode.style.display = 'none';
                } else {
                    fileMode.style.display = 'none';
                    inlineMode.style.display = 'block';
                    // Generate new UUID for inline script
                    const uuid = generateUUID();
                    inlineMode.querySelector('input').value = `script-${uuid}.bash`;
                }
            }
        }
        if (e.target.name === 'stage2-entry-mode') {
            const config = document.getElementById('stage2-entry-config');
            const fileMode = document.getElementById('stage2-entry-file-mode');
            const inlineMode = document.getElementById('stage2-entry-inline-mode');
            
            if (e.target.value === 'none') {
                config.style.display = 'none';
            } else {
                config.style.display = 'block';
                if (e.target.value === 'file') {
                    fileMode.style.display = 'block';
                    inlineMode.style.display = 'none';
                } else {
                    fileMode.style.display = 'none';
                    inlineMode.style.display = 'block';
                    // Generate new UUID for inline script
                    const uuid = generateUUID();
                    inlineMode.querySelector('input').value = `script-${uuid}.bash`;
                }
            }
        }
    });
</script>