version: '3'
x-cfg-stage-1:
  paths:
    _root_dir_host: ./installation/stage-1
    _root_dir_container: /init-me/stage-1
  build:
    output_image_name: my_image:stage-1
    base_image: ubuntu:22.04
    root_password: ''
    apps:
      with_essential_apps: true
      with_comstom_apps: true
    ssh:
      with_ssh: true
      username: me
      password: 123456
      port: 22
      pubkey_file: ''
    proxy:
      proxy_port: 7890
      proxy_address: host.docker.internal
      _proxy_http: http://host.docker.internal:7890
      _proxy_https: http://host.docker.internal:7890
    apt:
      source_file: /init-me/stage-1/system/apt/ubuntu-22.04-tsinghua-x64.list
      keep_source_file: true
      use_proxy: false
      keep_proxy: false
  run:
    ssh:
      host_port: 12222
    device: cpu
    environment: {}
x-cfg-stage-2:
  paths:
    _root_dir_host: ./installation/stage-2
    _root_dir_container: /init-me/stage-2
    _hard_apps: /hard/volume/apps
    _hard_data: /hard/volume/data
    _hard_workspace: /hard/volume/workspace
  build:
    output_image_name: my_image:stage-2
    base_image: my_image:stage-1
    apps:
      with_essential_apps: true
      with_comstom_apps: true
  run:
    ssh:
      host_port: 12222
    device: cpu
    environment: {}
  storage:
    type: image
    host-dirs:
      apps: null
      data: null
      workspace: null
    manual-volume-names:
      apps: null
      data: null
      workspace: null
x-sections:
  run-with-device:
    gpu:
    - driver: nvidia
      capabilities:
      - gpu
    cpu: []
    mps: []
  mount:
    auto-volume:
      volumes:
        app: null
        data: null
        workspace: null
        apt-cache: null
      runtime-mount:
      - app:/hard/volume/apps
      - data:/hard/volume/data
      - workspace:/hard/volume/workspace
      - apt-cache:/var/cache/apt/archives
    manual-volume:
      volumes:
        app:
          external: true
          name: null
        data:
          external: true
          name: null
        workspace:
          external: true
          name: null
        apt-cache: null
      runtime-mount:
      - app:/hard/volume/apps
      - data:/hard/volume/data
      - workspace:/hard/volume/workspace
      - apt-cache:/var/cache/apt/archives
    host:
      volumes:
        apt-cache: null
      runtime-mount:
      - None:/hard/volume/apps
      - None:/hard/volume/data
      - None:/hard/volume/workspace
      - apt-cache:/var/cache/apt/archives
    image:
      volumes:
        apt-cache: null
      runtime-mount:
      - apt-cache:/var/cache/apt/archives
services:
  stage-2:
    image: my_image:stage-2
    stdin_open: true
    tty: true
    command: /bin/bash
    ports:
    - '12222:22'
    deploy:
      resources:
        reservations:
          devices: []
    extra_hosts:
    - host.docker.internal:host-gateway
    volumes:
    - apt-cache:/var/cache/apt/archives
    build:
      context: .
      dockerfile: stage-2.Dockerfile
      extra_hosts:
      - host.docker.internal:host-gateway
      args:
        BASE_IMAGE: my_image:stage-1
        WITH_ESSENTIAL_APPS: true
        WITH_CUSTOM_APPS: true
        INSTALL_DIR_HOST_2: ./installation/stage-2
        INSTALL_DIR_CONTAINER_2: /init-me/stage-2
  stage-1:
    image: my_image:stage-1
    stdin_open: true
    tty: true
    command: /bin/bash
    ports:
    - '12222:22'
    deploy:
      resources:
        reservations:
          devices: []
    environment: {}
    extra_hosts:
    - host.docker.internal:host-gateway
    build:
      context: .
      dockerfile: stage-1.Dockerfile
      extra_hosts:
      - host.docker.internal:host-gateway
      args:
        BASE_IMAGE: ubuntu:22.04
        WITH_ESSENTIAL_APPS: true
        WITH_CUSTOM_APPS: true
        WITH_SSH: true
        SSH_USER_NAME: me
        SSH_USER_PASSWORD: 123456
        SSH_PUBKEY_FILE: ''
        APT_SOURCE_FILE: /init-me/stage-1/system/apt/ubuntu-22.04-tsinghua-x64.list
        KEEP_APT_SOURCE_FILE: true
        APT_USE_PROXY: false
        APT_KEEP_PROXY: false
        USER_HTTP_PROXY: http://host.docker.internal:7890
        USER_HTTPS_PROXY: http://host.docker.internal:7890
        INSTALL_DIR_HOST_1: ./installation/stage-1
        INSTALL_DIR_CONTAINER_1: /init-me/stage-1
        ROOT_PASSWORD: ''
volumes:
  apt-cache: null
